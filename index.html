<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Hub - Cloud Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style id="dynamicStyles">
        body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; color: #202124; }
        .google-card { background: white; border: 1px solid #dadce0; border-radius: 8px; transition: all 0.2s; cursor: pointer; }
        .google-card:hover { box-shadow: 0 4px 12px rgba(60,64,67,.15); transform: translateY(-1px); }
        .vacation-row { background-color: #fce8e6 !important; border-left: 4px solid #d93025; }
        .admin-only { display: none !important; }
        body[data-user-role="admin"] .admin-only { display: inline-flex !important; }
        body[data-user-role="admin"] .admin-only-block { display: block !important; }
        .dropdown:hover .dropdown-menu { display: block; }
        .tab-btn.active { color: #1a73e8; border-bottom: 3px solid #1a73e8; background-color: rgba(26, 115, 232, 0.05); }
        .large-modal { width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto; border-radius: 16px; }
    </style>
</head>
<body class="p-4 md:p-6" data-user-role="user">

    <div id="loginOverlay" class="fixed inset-0 z-[9999] bg-white flex items-center justify-center">
        <div class="relative text-center w-full max-sm:px-4 max-w-sm p-8 border rounded-2xl shadow-sm bg-white">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 text-white shadow-xl">
                <i data-lucide="shield-check" class="w-10 h-10"></i>
            </div>
            <h2 class="text-2xl mb-8 font-bold text-gray-800">Team Hub Cloud</h2>
            <input type="text" id="userInput" placeholder="Username" class="w-full p-4 border rounded-xl mb-3 outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="passInput" placeholder="Password" onkeypress="if(event.key === 'Enter') checkLogin()" class="w-full p-4 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="checkLogin()" class="w-full bg-[#1a73e8] text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all">Unlock</button>
            <p id="loginError" class="text-red-600 mt-4 text-sm hidden">خطأ في البيانات!</p>
        </div>
    </div>

    <div id="mainContent" class="hidden max-w-[1600px] mx-auto">
        <header class="flex flex-col md:flex-row-reverse justify-between items-center mb-6 pb-4 border-b gap-4">
            <div class="flex items-center gap-2">
                <div id="syncStatus" class="flex items-center gap-1 text-[10px] font-bold text-gray-400 mr-2 uppercase">
                    <i data-lucide="cloud-off" class="w-3 h-3"></i> Offline
                </div>
                <span id="displayRole" class="px-3 py-1 bg-blue-50 text-blue-700 text-[10px] rounded-full border font-black uppercase"></span>
            </div>
            
            <div class="flex flex-wrap gap-2 items-center">
                <div class="relative dropdown admin-only">
                    <button class="bg-gray-100 text-gray-700 px-4 py-2 rounded shadow-sm hover:bg-gray-200 transition-all font-bold flex items-center gap-2">
                        <i data-lucide="settings" class="w-4 h-4"></i> SETUP
                    </button>
                    <div class="dropdown-menu absolute left-0 mt-0 w-56 bg-white border rounded-xl shadow-xl hidden z-[2000]">
                        <button onclick="openCloudConfigModal()" class="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-2 text-sm border-b text-blue-700 font-bold">
                            <i data-lucide="database" class="w-4 h-4"></i> Database (GitHub)
                        </button>
                        <button onclick="openSetupModal()" class="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-2 text-sm border-b">
                            <i data-lucide="list" class="w-4 h-4"></i> Fields Setup
                        </button>
                        <button onclick="openDesignModal()" class="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-2 text-sm border-b">
                            <i data-lucide="palette" class="w-4 h-4"></i> Design Layout
                        </button>
                        <button onclick="openUsersModal()" class="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-2 text-sm">
                            <i data-lucide="users" class="w-4 h-4"></i> Manage Users
                        </button>
                    </div>
                </div>
                <button onclick="syncWithCloud()" class="bg-blue-50 text-blue-700 px-4 py-2 rounded border border-blue-200 hover:bg-blue-100 font-bold flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh Cloud
                </button>
                <button onclick="openModal()" class="admin-only bg-[#1a73e8] text-white px-6 py-2 rounded shadow hover:bg-blue-700 font-medium">+ Add Member</button>
            </div>
        </header>

        <div class="flex border-b border-gray-200 mb-6">
            <button onclick="switchTab('capacityTab', this)" id="defaultTab" class="tab-btn active px-6 py-3 font-bold text-gray-500 border-b-2">Capacity</button>
            <button onclick="switchTab('tableTab', this)" class="tab-btn px-6 py-3 font-bold text-gray-500 border-b-2">Team Table</button>
        </div>

        <div id="capacityTab" class="tab-content">
            <div id="capacityMainGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-4 border rounded-2xl bg-white shadow-sm">
                    <h3 class="text-blue-700 font-bold mb-3 flex justify-between border-b pb-2 uppercase text-[10px] tracking-widest">
                        <span><i data-lucide="code" class="inline w-4 h-4"></i> Developers</span>
                        <span id="devTotalLabel">Total: 0</span>
                    </h3>
                    <div id="devCapacityGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-2"></div>
                </div>
                <div class="p-4 border rounded-2xl bg-white shadow-sm">
                    <h3 class="text-green-700 font-bold mb-3 flex justify-between border-b pb-2 uppercase text-[10px] tracking-widest">
                        <span><i data-lucide="check-square" class="inline w-4 h-4"></i> Testers</span>
                        <span id="testerTotalLabel">Total: 0</span>
                    </h3>
                    <div id="testerCapacityGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-2"></div>
                </div>
            </div>
        </div>

        <div id="tableTab" class="tab-content hidden">
            <div class="google-card overflow-hidden">
                <table class="w-full text-left text-sm" id="employeeTable">
                    <thead class="bg-gray-50"><tr id="tableHeaderRow" class="text-gray-600 border-b"></tr></thead>
                    <tbody id="employeeTableBody" class="divide-y"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="cloudConfigModal" class="fixed inset-0 z-[1200] bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white large-modal max-w-lg p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-6 flex items-center gap-2"><i data-lucide="database"></i> GitHub Cloud Config</h3>
            <div class="space-y-4 mb-6">
                <input type="text" id="dbRepo" placeholder="Repo (e.g. username/reponame)" class="w-full p-3 border rounded-xl">
                <input type="text" id="dbPath" placeholder="File path (e.g. data.json)" class="w-full p-3 border rounded-xl">
                <input type="password" id="dbToken" placeholder="GitHub Token (ghp_...)" class="w-full p-3 border rounded-xl">
            </div>
            <button onclick="saveCloudConfig()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">Connect & Sync</button>
            <button onclick="closeCloudConfigModal()" class="w-full mt-2 py-2 text-gray-500">Close</button>
        </div>
    </div>

    <div id="setupModal" class="fixed inset-0 z-[1100] bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white large-modal p-6 shadow-2xl">
            <h3 class="font-bold mb-4">Fields Setup</h3>
            <div id="fieldsContainer" class="space-y-2 mb-4"></div>
            <button onclick="addField()" class="bg-gray-100 px-4 py-2 rounded text-sm font-bold mb-4">+ Add Field</button>
            <div class="flex gap-2"><button onclick="saveSetup()" class="bg-blue-600 text-white px-6 py-2 rounded">Save</button><button onclick="closeSetupModal()" class="px-6 py-2">Cancel</button></div>
        </div>
    </div>

    <div id="memberModal" class="fixed inset-0 z-[1000] bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white large-modal max-w-2xl p-6 shadow-2xl">
            <h3 id="modalTitle" class="text-xl font-bold mb-6">Add New Member</h3>
            <div id="dynamicFieldsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
            <div class="flex gap-3 justify-end"><button onclick="saveMember()" class="bg-blue-600 text-white px-8 py-2 rounded font-bold">Save</button><button onclick="closeModal()" class="bg-gray-200 px-8 py-2 rounded">Cancel</button></div>
        </div>
    </div>

    <div id="designModal" class="fixed inset-0 z-[1150] bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white large-modal max-w-lg p-6 shadow-2xl">
            <h3 class="font-bold mb-4">Design Layout</h3>
            <textarea id="cssEditor" class="w-full h-64 font-mono text-xs p-4 border rounded bg-gray-900 text-green-400"></textarea>
            <button onclick="saveDesign()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded">Apply CSS</button>
            <button onclick="closeDesignModal()" class="mt-4 px-6 py-2">Close</button>
        </div>
    </div>

    <div id="usersModal" class="fixed inset-0 z-[1160] bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white large-modal max-w-lg p-6 shadow-2xl">
            <h3 class="font-bold mb-4">Users Management</h3>
            <div id="usersList" class="space-y-3 mb-6"></div>
            <button onclick="addNewUser()" class="bg-gray-100 w-full py-2 mb-4">+ Add User</button>
            <button onclick="saveUsers()" class="bg-purple-600 text-white px-6 py-2 rounded w-full">Save Users</button>
            <button onclick="closeUsersModal()" class="mt-2 w-full text-gray-500">Cancel</button>
        </div>
    </div>

    <script>
        // App State
        const STORAGE_KEY = 'team_resource_db_v10';
        const CLOUD_CONFIG_KEY = 'team_hub_cloud_db_v1';
        
        let employees = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let cloudConfig = JSON.parse(localStorage.getItem(CLOUD_CONFIG_KEY)) || { repo: '', path: '', token: '' };
        let fieldsConfig = JSON.parse(localStorage.getItem('fields_setup_config')) || [
            { id: 'name', label: 'Full Name', type: 'text', required: true, showInTable: true },
            { id: 'role', label: 'Role', type: 'select', options: ['Dev', 'Senior', 'Tester', 'Senior tester'], showInTable: true },
            { id: 'area', label: 'Area', type: 'select', options: ["Registration", "Internal lab", "Integration"], showInTable: true },
            { id: 'status', label: 'Status', type: 'select', options: ['Active', 'Vacation'], showInTable: true }
        ];
        let users = JSON.parse(localStorage.getItem('team_hub_users')) || [{ username: 'admin', password: '123', role: 'admin' }];
        let currentEditId = null;
        let fileSha = null;

        // Login
        function checkLogin() {
            const u = document.getElementById('userInput').value;
            const p = document.getElementById('passInput').value;
            const found = users.find(x => x.username === u && x.password === p);
            if(found) {
                document.body.setAttribute('data-user-role', found.role);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('displayRole').innerText = `${found.username} (${found.role})`;
                if(cloudConfig.token) syncWithCloud(); else renderAll();
            } else { document.getElementById('loginError').classList.remove('hidden'); }
        }

        // Cloud Core Logic
        async function syncWithCloud() {
            if(!cloudConfig.token) return;
            updateSyncStatus('syncing', 'Connecting...');
            try {
                const res = await fetch(`https://api.github.com/repos/${cloudConfig.repo}/contents/${cloudConfig.path}`, {
                    headers: { 'Authorization': `token ${cloudConfig.token}` }
                });
                if(res.ok) {
                    const data = await res.json();
                    fileSha = data.sha;
                    const content = JSON.parse(atob(data.content));
                    employees = content.employees || [];
                    fieldsConfig = content.fieldsConfig || fieldsConfig;
                    saveLocally();
                    renderAll();
                    updateSyncStatus('online', 'Cloud Sync Active');
                } else { updateSyncStatus('offline', 'Error Path/Token'); }
            } catch(e) { updateSyncStatus('offline', 'Network Error'); }
        }

        async function saveToCloud() {
            if(!cloudConfig.token || !fileSha) return;
            const fullData = { employees, fieldsConfig, lastUpdate: new Date() };
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(fullData))));
            try {
                const res = await fetch(`https://api.github.com/repos/${cloudConfig.repo}/contents/${cloudConfig.path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${cloudConfig.token}` },
                    body: JSON.stringify({ message: 'Update', content, sha: fileSha })
                });
                if(res.ok) {
                    const data = await res.json();
                    fileSha = data.content.sha;
                    updateSyncStatus('online', 'Changes Saved');
                }
            } catch(e) { updateSyncStatus('offline', 'Save Failed'); }
        }

        function updateSyncStatus(status, text) {
            const el = document.getElementById('syncStatus');
            el.innerHTML = `<i data-lucide="${status === 'online' ? 'cloud-check' : (status === 'syncing' ? 'refresh-cw' : 'cloud-off')}"></i> ${text}`;
            el.className = `flex items-center gap-1 text-[10px] font-bold mr-2 uppercase ${status === 'online' ? 'text-emerald-500' : (status === 'syncing' ? 'text-blue-500 animate-spin' : 'text-red-500')}`;
            lucide.createIcons();
        }

        // Render Functions
        function renderAll() {
            renderTable();
            renderCapacity();
            lucide.createIcons();
        }

        function renderTable() {
            const header = document.getElementById('tableHeaderRow');
            header.innerHTML = fieldsConfig.filter(f => f.showInTable).map(f => `<th class="px-4 py-3 font-bold">${f.label}</th>`).join('') + '<th class="px-4 py-3 admin-only">Actions</th>';
            
            const body = document.getElementById('employeeTableBody');
            body.innerHTML = employees.map(emp => {
                const isVacation = emp.status === 'Vacation';
                return `<tr class="${isVacation ? 'vacation-row' : 'hover:bg-gray-50'}">
                    ${fieldsConfig.filter(f => f.showInTable).map(f => `<td class="px-4 py-3">${emp[f.id] || ''}</td>`).join('')}
                    <td class="px-4 py-3 admin-only">
                        <button onclick="editMember('${emp.id}')" class="text-blue-600 mr-2"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deleteMember('${emp.id}')" class="text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderCapacity() {
            const areas = fieldsConfig.find(f => f.id === 'area')?.options || [];
            const devGrid = document.getElementById('devCapacityGrid');
            const testerGrid = document.getElementById('testerCapacityGrid');
            
            let devTotal = 0, testerTotal = 0;

            const createCard = (area, roleType) => {
                const count = employees.filter(e => e.area === area && e.status !== 'Vacation' && e.role?.toLowerCase().includes(roleType)).length;
                if(roleType === 'dev') devTotal += count; else testerTotal += count;
                return `
                    <div class="p-3 border rounded-xl bg-gray-50 flex flex-col items-center">
                        <span class="text-[10px] text-gray-500 font-bold uppercase mb-1">${area}</span>
                        <span class="text-2xl font-black ${roleType === 'dev' ? 'text-blue-600' : 'text-green-600'}">${count}</span>
                    </div>`;
            };

            devGrid.innerHTML = areas.map(a => createCard(a, 'dev')).join('');
            testerGrid.innerHTML = areas.map(a => createCard(a, 'tester')).join('');
            document.getElementById('devTotalLabel').innerText = `Total: ${devTotal}`;
            document.getElementById('testerTotalLabel').innerText = `Total: ${testerTotal}`;
        }

        // Member Logic
        function openModal(id = null) {
            currentEditId = id;
            const emp = id ? employees.find(e => e.id === id) : {};
            document.getElementById('modalTitle').innerText = id ? 'Edit Member' : 'Add Member';
            const container = document.getElementById('dynamicFieldsContainer');
            container.innerHTML = fieldsConfig.map(f => {
                if(f.type === 'select') {
                    return `<div><label class="block text-xs font-bold mb-1">${f.label}</label>
                            <select id="field_${f.id}" class="w-full p-2 border rounded">
                                ${f.options.map(opt => `<option value="${opt}" ${emp[f.id] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select></div>`;
                }
                return `<div><label class="block text-xs font-bold mb-1">${f.label}</label>
                        <input type="${f.type}" id="field_${f.id}" value="${emp[f.id] || ''}" class="w-full p-2 border rounded"></div>`;
            }).join('');
            document.getElementById('memberModal').classList.remove('hidden');
        }

        function saveMember() {
            const newEmp = { id: currentEditId || Date.now().toString() };
            fieldsConfig.forEach(f => { newEmp[f.id] = document.getElementById(`field_${f.id}`).value; });
            if(currentEditId) {
                const idx = employees.findIndex(e => e.id === currentEditId);
                employees[idx] = newEmp;
            } else { employees.push(newEmp); }
            save();
            closeModal();
        }

        function deleteMember(id) { if(confirm('Are you sure?')) { employees = employees.filter(e => e.id !== id); save(); } }

        function save() {
            saveLocally();
            renderAll();
            if(cloudConfig.token) saveToCloud();
        }

        function saveLocally() { localStorage.setItem(STORAGE_KEY, JSON.stringify(employees)); }

        // Settings Modals
        function openCloudConfigModal() {
            document.getElementById('dbRepo').value = cloudConfig.repo;
            document.getElementById('dbPath').value = cloudConfig.path;
            document.getElementById('dbToken').value = cloudConfig.token;
            document.getElementById('cloudConfigModal').classList.remove('hidden');
        }
        function saveCloudConfig() {
            cloudConfig = { repo: document.getElementById('dbRepo').value, path: document.getElementById('dbPath').value, token: document.getElementById('dbToken').value };
            localStorage.setItem(CLOUD_CONFIG_KEY, JSON.stringify(cloudConfig));
            document.getElementById('cloudConfigModal').classList.add('hidden');
            syncWithCloud();
        }
        function closeCloudConfigModal() { document.getElementById('cloudConfigModal').classList.add('hidden'); }
        
        // Setup Modal Logic
        function openSetupModal() {
            const container = document.getElementById('fieldsContainer');
            container.innerHTML = fieldsConfig.map((f, i) => `
                <div class="flex gap-2 items-center bg-gray-50 p-2 rounded">
                    <input type="text" value="${f.label}" onchange="updateField(${i}, 'label', this.value)" class="p-1 border rounded text-xs flex-1">
                    <select onchange="updateField(${i}, 'type', this.value)" class="text-xs p-1 border rounded">
                        <option value="text" ${f.type === 'text' ? 'selected' : ''}>Text</option>
                        <option value="select" ${f.type === 'select' ? 'selected' : ''}>Select</option>
                    </select>
                    <button onclick="removeField(${i})" class="text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>`).join('');
            document.getElementById('setupModal').classList.remove('hidden');
            lucide.createIcons();
        }

        // Tab Switching
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            btn.classList.add('active');
        }

        function closeModal() { document.getElementById('memberModal').classList.add('hidden'); }
        function closeSetupModal() { document.getElementById('setupModal').classList.add('hidden'); }
        function openDesignModal() { document.getElementById('designModal').classList.remove('hidden'); }
        function closeDesignModal() { document.getElementById('designModal').classList.add('hidden'); }
        function openUsersModal() { document.getElementById('usersModal').classList.remove('hidden'); }
        function closeUsersModal() { document.getElementById('usersModal').classList.add('hidden'); }

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>
